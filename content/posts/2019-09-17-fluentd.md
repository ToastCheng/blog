---
title:  "Note: Fluentd"
date:   2019-09-17T21:45:14+0800
tags: [note, fluentd, backend]
categories: technique
---

[Fluentd](https://docs.fluentd.org/) is a powerful open-source logging tool that has flexible functionalities. 

The overall fluentd's workflow:

![](https://gblobscdn.gitbook.com/assets%2F-LR7OsqPORtP86IQxs6E%2F-LWNPJuIG9Ym5ELlFCti%2F-LWNPOPNQ1l9hvoJ2FIp%2Ffluentd-architecture.png?alt=media)


The logic behinds fluentd is quite simple:
1. There are sources of data, such as file, http traffic, etc., you tell fluentd what to listen.
2. You define **rule**s that specify what **event** should be logged.
3. You define how the **event** should be processed.

The simplified structure of fluentd's configuration file can reflect the logic above:
```xml
<source>
  1. You tell fluentd what to listen.
</source>

<filter>
  2. You tell fluentd what should be logged.
</filter>

<match>
  3. You tell fluentd what to do with the data.
</match>
```



### Event
A fluentd event consists of:
- `tag`, where an event comes from
- `time`
- `record`, log content, JSON object



### Plugins
A plugin in the context of fluentd is a kind of logic of operation. There are plenty of kinds of frequently used plugins.
#### 1. Input plugin
Input plugin creates a `thread`, `socket`, and `listening socket`, it's used with the `<source>` directive that specify what kind of source that should be listen.

- `tail`: tailing a target file as source, the `path` field specifies the file path to be tail.
```xml
<source>
  @type tail
  path /var/log/httpd-access.log
  tag tag.xxx
</source>
```

- `http`: listening http traffic
```xml
<source>
  @type http
  port 9880
  bind 0.0.0.0
  body_size_limit 32m
  keepalive_timeout 10s
</source>
```
#### 2. Parse plugin
Used with `<parse>` directive, transform the data to different form, the frequently used parser is `json`.
- `json`
```xml
<parse>
  @type json
  json_parser json
</parse>
```
You will need to put the `<parser>` nested inside `<source>` or `<filter>`, the parser helps 

#### 3. Formatter plugin


#### 4. Filter plugin

#### 5. Output plugin
Output plugin are used with `<match>` directive.

- `file`: output logs to file.
```xml
<match pattern>
  @type file
  path /var/log/fluent/myapp
  compress gzip
  <buffer>
    timekey 1d
    timekey_use_utc true
    timekey_wait 10m
  </buffer>
</match>
```

### Example

listening for **HTTP requests** on port 8888:
```fluentd
<source>
    @type http
    port 8888
    bind 0.0.0.0
</source>
```

if the **in coming event** has a **Tag** equals to `test.cycle`, the rule will be matched:
```fluentd
<match test.cycle>
    @type stdout
</match>
```

```sh
$ curl -i -X POST -d 'json={"action":"login","user":2}' http://localhost:8888/test.cycle
HTTP/1.1 200 OK
Content-type: text/plain
Connection: Keep-Alive
Content-length: 0
```



### Integrate fluentd with k8s

For Kubernetes, a DaemonSet ensures that all (or some) nodes run a copy of a pod.
In order to solve log collection we are going to implement a Fluentd DaemonSet.

`// TODO`

##### References
- [How To Set Up an Elasticsearch, Fluentd and Kibana (EFK) Logging Stack on Kubernetes](https://www.digitalocean.com/community/tutorials/how-to-set-up-an-elasticsearch-fluentd-and-kibana-efk-logging-stack-on-kubernetes)
- [fluentd-k8s](https://docs.fluentd.org/container-deployment/kubernetes)
